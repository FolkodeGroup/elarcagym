generator client {
  provider = "prisma-client-js"
  // output comentado para usar la ubicación por defecto: node_modules/@prisma/client
  // output   = "../src/generated/prisma/client"
}

datasource db {
  provider = "postgresql"
  // url se configura ahora en prisma.config.ts (Prisma 7+)
}

model Member {
  id              String   @id @default(uuid())
  firstName       String
  lastName        String
  dni             String   @unique
  email           String?  @unique
  password        String?  // Opcional - solo para admins, no para socios regulares
  phone           String
  joinDate        DateTime @default(now())
  status          String
  photoUrl        String?
  phase           String?
  bioObjective    String?
  lastAttendance  DateTime?
  nutritionPlan   Json?    // Almacena NutritionData como JSON
  habitualSchedules  HabitualSchedule[]
  scheduleExceptions ScheduleException[]
  biometrics      BiometricLog[]
  routines        Routine[]
  diets           Diet[]
  payments        PaymentLog[]
  sales           Sale[]        @relation("MemberSales")
  reservations    Reservation[] @relation("MemberReservations")
}

model HabitualSchedule {
  id        String   @id @default(uuid())
  day       String
  start     String
  end       String
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model ScheduleException {
  id        String   @id @default(uuid())
  date      DateTime              // Fecha específica de la excepción
  start     String                // Hora de inicio (HH:mm)
  end       String                // Hora de fin (HH:mm)
  reason    String?               // Motivo opcional del cambio
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([memberId, date])
}

model BiometricLog {
  id         String   @id @default(uuid())
  date       DateTime
  weight     Float
  height     Float?
  bodyFat    Float?
  chest      Float?
  waist      Float?
  abdomen    Float?
  hips       Float?
  glutes     Float?
  rightThigh Float?
  leftThigh  Float?
  rightCalf  Float?
  leftCalf   Float?
  rightArm   Float?
  leftArm    Float?
  neck       Float?
  memberId   String
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model Routine {
  id        String   @id @default(uuid())
  name      String
  goal      String
  assignedBy String
  createdAt DateTime @default(now())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  days      RoutineDay[]

  @@unique([name, memberId])
}

model RoutineDay {
  id        String   @id @default(uuid())
  dayName   String
  routineId String
  routine   Routine  @relation(fields: [routineId], references: [id], onDelete: Cascade)
  exercises ExerciseDetail[]
}

model ExerciseDetail {
  id        String   @id @default(uuid())
  name      String
  series    String
  reps      String
  weight    String
  notes     String?
  routineDayId String
  routineDay   RoutineDay @relation(fields: [routineDayId], references: [id], onDelete: Cascade)
}

model Diet {
  id        String   @id @default(uuid())
  name      String
  calories  Int
  description String
  generatedAt DateTime @default(now())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model PaymentLog {
  id        String   @id @default(uuid())
  date      DateTime
  amount    Float
  concept   String
  method    String
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model Product {
  id        String   @id @default(uuid())
  name      String
  price     Float
  category  String
  stock     Int
  imageUrl  String?  // URL o base64 de imagen del producto
  sales     SaleItem[]
}

model Sale {
  id        String   @id @default(uuid())
  date      DateTime @default(now())
  total     Float
  memberId  String?
  member    Member?  @relation("MemberSales", fields: [memberId], references: [id])
  items     SaleItem[]
}

model SaleItem {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  quantity    Int
  priceAtSale Float
  productName String?
}

model Reminder {
  id        String   @id @default(uuid())
  text      String
  date      DateTime
  priority  String
}

model Slot {
  id        String   @id @default(uuid())
  date      DateTime
  time      String
  duration  Int
  status    String
  target    String?
  color     String?
  reservations Reservation[]
}

model Reservation {
  id          String   @id @default(uuid())
  slotId      String
  slot        Slot     @relation(fields: [slotId], references: [id], onDelete: Cascade)
  memberId    String?
  member      Member?  @relation("MemberReservations", fields: [memberId], references: [id])
  clientName  String
  clientPhone String?
  clientEmail String?
  notes       String?
  attended    Boolean?
  accessedAt  DateTime?
  createdAt   DateTime @default(now())
}

model ExerciseMaster {
  id        String   @id @default(uuid())
  name      String
  category  String
}

model Config {
  id                String   @id @default(uuid())
  key               String   @unique
  value             String
  description       String?
  updatedAt         DateTime @updatedAt
}

// ===================== SISTEMA DE USUARIOS Y ROLES =====================

enum UserRole {
  ADMIN     // Administrador - acceso total
  TRAINER   // Profesor/Entrenador - acceso limitado
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  dni           String   @unique
  phone         String?
  role          UserRole @default(TRAINER)
  isActive      Boolean  @default(true)
  photoUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Relación con permisos personalizados
  permissions   UserPermission[]
  
  // Notificaciones del usuario
  notifications Notification[]
  
  // Rutinas creadas por este usuario (entrenador)
  createdRoutines String[] // IDs de rutinas creadas
}

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique   // ej: "members.view", "members.edit", "sales.create"
  name        String             // Nombre legible: "Ver Socios"
  description String?
  module      String             // Módulo: "members", "sales", "routines", etc.
  
  userPermissions UserPermission[]
}

model UserPermission {
  id           String   @id @default(uuid())
  userId       String
  permissionId String
  granted      Boolean  @default(true)  // true = permitido, false = denegado explícitamente
  
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, permissionId])
}

// ===================== SISTEMA DE NOTIFICACIONES =====================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   // info, success, warning, error
  link      String?  // URL relativa para navegar cuando se hace clic
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([createdAt])
}

// ===================== MODELO DE LISTA DE ESPERA =====================
model Waitlist {
  id               String   @id @default(uuid())
  firstName        String
  lastName         String
  phone            String
  reservationDate  DateTime
  status           String?
}

// ===================== PLANTILLA DE RECOMENDACIONES NUTRICIONALES =====================
model NutritionTemplate {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text  // Contenido de las recomendaciones en texto plano
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
